name: Flux CI

on:
  push:
    branches: [ "main" ]
    paths:
      - '**.yaml'
      - '**.yml'
  pull_request:
    branches: [ "main" ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@main

      - name: Setup Kubeconform
        uses: fluxcd/pkg/actions/kubeconform@main

      # 1. Validate Flux Kustomizations
      - name: Validate Kustomization Build
        run: |
          # Finds all kustomization.yaml files and attempts to build them
          find . -type f -name kustomization.yaml -exec dirname {} \; | while read dir; do
            echo "Building $dir..."
            kustomize build "$dir" --load-restrictor LoadRestrictionsNone > /dev/null
          done

      - name: Kubeconform Validation
        run: |
          find . -type f \( -name '*.yaml' -o -name '*.yml' \) \
            -not -name 'kustomization.yaml' \
            -not -path '*/.github/*' \
            -not -path '*/.yamllint*' \
            -print0 | xargs -0 kubeconform -strict -summary -ignore-missing-schemas \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json'

